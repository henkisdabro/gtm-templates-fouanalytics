___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "FouAnalytics",
  "categories": [
    "ANALYTICS"
  ],
  "brand": {
    "id": "github.com_henkisdabro",
    "displayName": "wookstar",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Load the FouAnalytics library in a safe(r) way using a custom tag template.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "sourceUrl",
    "displayName": "FouAnalytics Script URL",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          "^https://.*"
        ],
        "errorMessage": "The URL must start with \"https://\""
      },
      {
        "type": "REGEX",
        "args": [
          "^https://api\\.fouanalytics\\.com/.+"
        ],
        "errorMessage": "The URL must include the api.fouanalytics.com hostname"
      },
      {
        "type": "REGEX",
        "args": [
          ".+init-[0-9a-z]+\\.js$"
        ],
        "errorMessage": "The URL needs to end with the \"init-xxxxxxxxxxxxxxxxxxxx.js\" string"
      }
    ],
    "help": "Copy paste the on-site URL from your FouAnalytics settings"
  },
  {
    "type": "CHECKBOX",
    "name": "debug",
    "checkboxText": "Log debug messages to console",
    "simpleValueType": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Require the necessary APIs
const logToConsole = require('logToConsole');
const injectScript = require('injectScript');
const queryPermission = require('queryPermission');

// Get the URL the user input into the text field
const url = data.sourceUrl;

// If the user chose to log debug output, initialize the logging method
const log = data.debug ? logToConsole : (() => {});

log('FouAnalytics: Loading script from ' + url);

// If the script loaded successfully, log a message and signal success
const onSuccess = () => {
  log('FouAnalytics: Script loaded successfully.');
  data.gtmOnSuccess();
};

// If the script fails to load, log a message and signal failure
const onFailure = () => {
  log('FouAnalytics: Script load failed.');
  data.gtmOnFailure();
};

// If the URL input by the user matches the permissions set for the template,
// inject the script with the onSuccess and onFailure methods as callbacks.
if (queryPermission('inject_script', url)) {
  injectScript(url, onSuccess, onFailure, url);
} else {
  log('FouAnalytics: Script load failed due to permissions mismatch.');
  data.gtmOnFailure();
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://api.fouanalytics.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Script loads successfully
  code: |-
    const mockData = {
      sourceUrl: 'https://api.fouanalytics.com/v1/init-abc123def456.js',
      debug: false
    };

    mock('injectScript', function(url, onSuccess, onFailure, cacheToken) {
      onSuccess();
    });

    mock('queryPermission', function(permission, url) {
      return true;
    });

    runCode(mockData);
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();

- name: Script fails to load
  code: |-
    const mockData = {
      sourceUrl: 'https://api.fouanalytics.com/v1/init-abc123def456.js',
      debug: false
    };

    mock('injectScript', function(url, onSuccess, onFailure, cacheToken) {
      onFailure();
    });

    mock('queryPermission', function(permission, url) {
      return true;
    });

    runCode(mockData);
    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();

- name: Permission denied triggers failure
  code: |-
    const mockData = {
      sourceUrl: 'https://api.fouanalytics.com/v1/init-abc123def456.js',
      debug: false
    };

    mock('queryPermission', function(permission, url) {
      return false;
    });

    runCode(mockData);
    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
    assertApi('injectScript').wasNotCalled();

- name: Debug mode logs messages on success
  code: |-
    const mockData = {
      sourceUrl: 'https://api.fouanalytics.com/v1/init-abc123def456.js',
      debug: true
    };

    mock('injectScript', function(url, onSuccess, onFailure, cacheToken) {
      onSuccess();
    });

    mock('queryPermission', function(permission, url) {
      return true;
    });

    runCode(mockData);
    assertApi('logToConsole').wasCalled();
    assertApi('gtmOnSuccess').wasCalled();

- name: Debug mode disabled does not log
  code: |-
    const mockData = {
      sourceUrl: 'https://api.fouanalytics.com/v1/init-abc123def456.js',
      debug: false
    };

    mock('injectScript', function(url, onSuccess, onFailure, cacheToken) {
      onSuccess();
    });

    mock('queryPermission', function(permission, url) {
      return true;
    });

    runCode(mockData);
    assertApi('logToConsole').wasNotCalled();
    assertApi('gtmOnSuccess').wasCalled();

- name: CacheToken is passed to injectScript
  code: |-
    const mockData = {
      sourceUrl: 'https://api.fouanalytics.com/v1/init-abc123def456.js',
      debug: false
    };

    let capturedCacheToken;
    mock('injectScript', function(url, onSuccess, onFailure, cacheToken) {
      capturedCacheToken = cacheToken;
      onSuccess();
    });

    mock('queryPermission', function(permission, url) {
      return true;
    });

    runCode(mockData);
    assertThat(capturedCacheToken).isEqualTo(mockData.sourceUrl);


___NOTES___

Created on 20/12/2024, 9:03:25 am


